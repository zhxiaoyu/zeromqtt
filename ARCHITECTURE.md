# ZeroMQTT 架构文档

## 概述

ZeroMQTT 是一个高性能的双向桥接系统，实现了 ZeroMQ 和 MQTT 协议之间的无缝消息传输。系统采用模块化设计，具有良好的可扩展性和可维护性。
并在原有基础上增加了现代化的 Web 管理界面、全链路监控 (OTLP) 以及多样化的部署支持。

## 系统架构

### 核心组件

```
┌─────────────────────────────────────────────────────────────┐
│                       ZeroMQTT Bridge                       │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │   Config    │  │   Bridge    │  │    Utils/Logging    │  │
│  │   Manager   │  │   Core      │  │                     │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
├───────────────────────┬──────────────────────┬──────────────┤
│  ┌─────────────┐      │    ┌─────────────┐   │ ┌──────────┐ │
│  │    MQTT     │◄─────┼───►│ Web Server  │   │ │ Telemetry│ │
│  │   Client    │      │    │   (Axum)    │   │ │  (OTLP)  │ │
│  └─────────────┘      │    └─────────────┘   │ └──────────┘ │
├───────────────────────▼──────────────────────▼──────────────┤
│  ┌─────────────┐                    ┌─────────────────────┐  │
│  │    MQTT     │◄──── Messages ────►│      ZeroMQ         │  │
│  │   Client    │                    │      Client         │  │
│  └─────────────┘                    └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
           │               ▲                        │      ▲
           ▼               │ (Manage/Monitor)       ▼      │ (Metrics)
┌─────────────────┐   ┌────┴─────┐       ┌──────────────┐  │
│   MQTT Broker   │   │ Browser  │       │  ZeroMQ Net  │  │
│                 │   │ (Vue/UI) │       │              │  │
│  - Publishers   │   └──────────┘       └──────────────┘  │
│  - Subscribers  │                                        │
│  - Topics       │   ┌───────────────┐                    │
└─────────────────┘   │ OTLP Collector│◄───────────────────┘
                      └───────────────┘
```

### 模块说明

#### 1. 配置管理
- **SQLite Database**: 所有配置数据持久化存储于 SQLite
- **Config**: 负责数据库连接池管理和配置热加载
- **Migration**: 自动处理数据库结构变更

#### 2. MQTT 客户端
- 封装 paho-mqtt 客户端
- 自动重连机制
- 消息队列管理
- TLS/SSL 支持
- 回调函数处理

#### 3. ZeroMQ 客户端
- 封装 zmq 套接字
- PUB/SUB 模式支持
- 多线程消息处理
- 自动重连机制
- 高水位标记配置

#### 4. 桥接核心
- **ZeroMQTTBridge**: 主桥接类
- 双向消息转发
- 主题映射和转换
- 心跳机制
- 优雅关闭处理

#### 5. Web 管理子系统 (新增)
- **后端 (Axum)**:
  - 提供 RESTful API 用于运行时配置管理和状态查询
  - 集成 `vite-rs` 实现前端静态资源嵌入二进制文件
  - **身份认证**: 
    - 默认账户/密码: `zeromqtt` / `zeromqtt`
    - JWT Token 鉴权
- **前端 (Vue 3 + TypeScript + TailwindCSS)**:
  - 实时状态大屏 (Dashboard)
  - 动态配置连接参数和映射规则
  - 响应式设计

#### 6. 监控与遥测 (新增)
- **OpenTelemetry 集成**:
  - 提供 Prometheus 兼容的 Metrics 接口
  - 支持 OTLP 协议导出 Trace 和 Metric 数据
  - 关键指标：消息吞吐量、延迟直方图、队列堆积量、丢包率

#### 7. 工具函数与异常处理
- 重试装饰器、性能监控、安全编解码
- 自定义异常类、错误分类

## 消息流程 (更新)

### 观察性增强
在原有的 MQTT ↔ ZeroMQ 转发流程中，增加埋点：
1. 消息进入桥接层时记录 Start Span
2. 转换和映射过程中增加 Event 记录
3. 发送成功/失败更新 Counter 和 Histogram 指标

## 部署与构建 (新增)

### 1. 跨平台构建
- 支持 `cargo-zigbuild` 进行交叉编译，确保在不同架构 (x86_64, aarch64) 下的兼容性。

### 2. 包管理
- **Debian Package**: 使用 `cargo-deb` 生成 `.deb` 安装包，包含：
  - 二进制文件
  - Systemd Unit 文件 (`/lib/systemd/system/zeromqtt.service`)
  - 默认配置文件

### 3. Systemd 集成
- 提供标准 Service 文件，支持：
  - 开机自启
  - 崩溃自动重启
  - 日志重定向到 journald

### 4. 容器化
- 提供多架构 `Dockerfile`
- 基于 `alpine` 以减小镜像体积
- 支持通过环境变量覆盖配置文件

## 主题映射

Mapping 规则保持不变，支持通配符 `+` 和 `#`。

## 并发模型

在原有线程模型基础上增加：
1. **Web Server 线程**: Axum 异步运行时 (Tokio Runtime)
2. **Telemetry 线程**: 后台批量导出监控数据

## 性能优化

- Web 接口与核心转发路径分离，避免阻塞
- OTLP 导出采用异步批量模式
